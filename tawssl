#!/bin/bash

#############################################
# Tawssl - ArvanCloud SSL Generator v2.0
# Clean Architecture - No Bugs
#############################################

# Colors
C='\033[0;36m'
G='\033[0;32m'
R='\033[0;31m'
Y='\033[1;33m'
N='\033[0m'

# Paths
ACME_HOME="$HOME/.acme.sh"
ACME_BIN="$ACME_HOME/acme.sh"
CERT_DIR="/tmp/tawssl-certs"

#############################################
# Logging Functions
#############################################
info() { echo -e "${C}[INFO]${N} $1"; }
ok() { echo -e "${G}[OK]${N} $1"; }
err() { echo -e "${R}[ERROR]${N} $1"; }

#############################################
# Install Dependencies
#############################################
install_deps() {
    for pkg in socat curl openssl; do
        if ! command -v $pkg &>/dev/null; then
            info "Installing $pkg..."
            if command -v apt-get &>/dev/null; then
                apt-get update -qq && apt-get install -y -qq $pkg
            elif command -v yum &>/dev/null; then
                yum install -y -q $pkg
            fi
        fi
    done
}

#############################################
# Install acme.sh
#############################################
install_acme() {
    if [ ! -f "$ACME_BIN" ]; then
        info "Installing acme.sh..."
        curl -s https://get.acme.sh | sh -s email=admin@tawssl.com &>/dev/null
        [ -f "$ACME_HOME/acme.sh.env" ] && source "$ACME_HOME/acme.sh.env"
    fi
    
    if [ -f "$ACME_BIN" ]; then
        $ACME_BIN --set-default-ca --server letsencrypt &>/dev/null
    else
        err "Failed to install acme.sh"
        exit 1
    fi
}

#############################################
# Generate SSL Certificate
#############################################
generate_cert() {
    echo ""
    read -p "$(echo -e ${Y}Enter Domain \(e.g. example.com\): ${N})" DOMAIN
    read -p "$(echo -e ${Y}Enter ArvanCloud API Key: ${N})" API_KEY
    
    export Arvan_Token="$API_KEY"
    
    # Clean old certs
    info "Cleaning old certificates for $DOMAIN..."
    $ACME_BIN --remove -d "$DOMAIN" &>/dev/null
    $ACME_BIN --remove -d "*.$DOMAIN" &>/dev/null
    rm -rf "$ACME_HOME/${DOMAIN}"*
    
    # Issue new certificate
    info "Requesting Wildcard SSL (RSA 4096) for *.$DOMAIN..."
    $ACME_BIN --issue --dns dns_arvan \
        -d "$DOMAIN" \
        -d "*.$DOMAIN" \
        --keylength 4096 \
        --force
    
    if [ $? -ne 0 ]; then
        err "Certificate issuance failed. Check your API key."
        read -p "Press Enter to continue..."
        return 1
    fi
    
    # Export certificates
    rm -rf "$CERT_DIR"
    mkdir -p "$CERT_DIR"
    
    $ACME_BIN --install-cert -d "$DOMAIN" \
        --cert-file "$CERT_DIR/certificate.crt" \
        --key-file "$CERT_DIR/private.key" \
        --reloadcmd "true" &>/dev/null
    
    ok "Certificate generated successfully!"
    
    display_certs
    offer_install
}

#############################################
# Display Certificates
#############################################
display_certs() {
    echo ""
    echo -e "${Y}========================================================${N}"
    echo -e "${Y}           ğŸ“‹ CERTIFICATES READY ğŸ“‹                    ${N}"
    echo -e "${Y}========================================================${N}"
    
    echo ""
    echo -e "${C}--- PUBLIC KEY (For Panel/Node) ---${N}"
    if [ -f "$CERT_DIR/certificate.crt" ]; then
        cat "$CERT_DIR/certificate.crt"
    else
        err "Certificate file not found!"
    fi
    echo -e "${C}--- END PUBLIC KEY ---${N}"
    
    echo ""
    echo -e "${R}--- PRIVATE KEY (For Node Only) ---${N}"
    if [ -f "$CERT_DIR/private.key" ]; then
        cat "$CERT_DIR/private.key"
    else
        err "Private key file not found!"
    fi
    echo -e "${R}--- END PRIVATE KEY ---${N}"
    echo ""
}

#############################################
# Offer Node Installation
#############################################
offer_install() {
    echo -e "${Y}========================================================${N}"
    echo -e "${C}Install a Node/Panel on this server?${N}"
    echo "1) Pasargad Node"
    echo "2) Marzban Node"
    echo "3) No, return to menu"
    echo ""
    read -p "$(echo -e ${Y}Select [1-3]: ${N})" choice
    
    case $choice in
        1)
            echo ""
            info "Launching Pasargad Node installer..."
            echo -e "${Y}When asked for certificate, paste the PUBLIC KEY above.${N}"
            echo -e "${Y}When asked for private key, paste the PRIVATE KEY above.${N}"
            read -p "Press Enter to start..."
            bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pg-node.sh)" @ install
            ;;
        2)
            echo ""
            info "Launching Marzban Node installer..."
            echo -e "${Y}When asked for certificate, paste the PUBLIC KEY above.${N}"
            echo -e "${Y}When asked for private key, paste the PRIVATE KEY above.${N}"
            read -p "Press Enter to start..."
            bash -c "$(curl -sL https://github.com/Gozargah/Marzban-scripts/raw/master/marzban-node.sh)" @ install
            ;;
        3)
            return
            ;;
    esac
}

#############################################
# List Existing Certificates
#############################################
list_certs() {
    echo ""
    info "Existing certificates:"
    if [ -f "$ACME_BIN" ]; then
        $ACME_BIN --list
    else
        err "acme.sh not installed"
    fi
    echo ""
    read -p "Press Enter to continue..."
}

#############################################
# Main Menu
#############################################
show_menu() {
    clear
    echo -e "${C}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${N}"
    echo -e "${C}â•‘      Tawssl Manager v2.0          â•‘${N}"
    echo -e "${C}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${N}"
    echo ""
    echo "1) Generate New Wildcard SSL"
    echo "2) List Existing Certificates"
    echo "3) Exit"
    echo ""
    read -p "$(echo -e ${Y}Select [1-3]: ${N})" choice
    
    case $choice in
        1) generate_cert ;;
        2) list_certs ;;
        3) exit 0 ;;
        *) show_menu ;;
    esac
}

#############################################
# Initialization & Main Loop
#############################################
info "Initializing Tawssl..."
install_deps
install_acme
ok "Ready!"
sleep 1

while true; do
    show_menu
done
